generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum ConsultationStatus {
  PENDING
  IN_PROGRESS
  AWAITING_RESPONSE
  COMPLETED
  CANCELLED
}

enum MessageType {
  TEXT
  VIDEO
  IMAGE
  SYSTEM
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  password          String
  role              UserRole @default(PATIENT)
  firstName         String
  lastName          String
  phone             String?
  language          String   @default("en")
  notificationPrefs Json?    // {sms: bool, whatsapp: bool, email: bool}
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  patientConsultations Consultation[] @relation("PatientConsultations")
  doctorConsultations  Consultation[] @relation("DoctorConsultations")
  messages             Message[]
  photos               Photo[]

  @@map("users")
}

model Consultation {
  id          String             @id @default(cuid())
  patientId   String
  doctorId    String?
  status      ConsultationStatus @default(PENDING)
  chiefComplaint String
  intakeData  Json               // Smart intake form data
  priority    String             @default("normal") // normal, urgent
  scheduledAt DateTime?
  completedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relations
  patient  User      @relation("PatientConsultations", fields: [patientId], references: [id])
  doctor   User?     @relation("DoctorConsultations", fields: [doctorId], references: [id])
  messages Message[]
  photos   Photo[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@map("consultations")
}

model Message {
  id             String      @id @default(cuid())
  consultationId String
  senderId       String
  type           MessageType @default(TEXT)
  content        String      @db.Text
  metadata       Json?       // For video URLs (Loom), file info, etc.
  readAt         DateTime?
  createdAt      DateTime    @default(now())

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([consultationId])
  @@index([senderId])
  @@map("messages")
}

model Photo {
  id             String   @id @default(cuid())
  consultationId String
  userId         String
  url            String
  thumbnailUrl   String?
  description    String?
  takenAt        DateTime @default(now())
  metadata       Json?    // EXIF data, comparison info
  createdAt      DateTime @default(now())

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([consultationId])
  @@index([userId])
  @@map("photos")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // sms, whatsapp, email
  status    String   // pending, sent, failed
  content   String   @db.Text
  metadata  Json?
  sentAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@map("notifications")
}